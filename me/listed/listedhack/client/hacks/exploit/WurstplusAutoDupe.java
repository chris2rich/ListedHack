package me.listed.listedhack.client.hacks.exploit;

import java.util.Comparator;
import java.util.function.Predicate;
import me.listed.listedhack.client.guiscreen.settings.WurstplusSetting;
import me.listed.listedhack.client.hacks.WurstplusCategory;
import me.listed.listedhack.client.hacks.WurstplusHack;
import me.listed.listedhack.client.util.WurstplusMessageUtil;
import me.listed.listedhack.client.util.WurstplusTimer;
import me.zero.alpine.fork.listener.EventHandler;
import me.zero.alpine.fork.listener.Listener;
import net.minecraft.block.Block;
import net.minecraft.block.BlockChest;
import net.minecraft.client.gui.inventory.GuiScreenHorseInventory;
import net.minecraft.entity.Entity;
import net.minecraft.entity.passive.AbstractChestHorse;
import net.minecraft.init.Items;
import net.minecraft.inventory.ClickType;
import net.minecraft.item.ItemBlock;
import net.minecraft.item.ItemShulkerBox;
import net.minecraft.item.ItemStack;
import net.minecraft.network.play.client.CPacketUseEntity;
import net.minecraft.util.EnumHand;
import net.minecraftforge.event.entity.EntityJoinWorldEvent;
import org.lwjgl.input.Keyboard;

public class WurstplusAutoDupe extends WurstplusHack {
   WurstplusSetting delay = this.create("Delay", "Delay", 1, 0, 10);
   WurstplusSetting shulker_only = this.create("Shulker Only", "ShulkerOnly", true);
   WurstplusSetting hit_ground = this.create("Hit Ground", "HitGround", true);
   private boolean doDrop = false;
   private boolean doChest = false;
   private boolean doSneak = false;
   private boolean start = false;
   private boolean finished = false;
   private boolean grounded = false;
   private int itemsToDupe;
   private int itemsMoved;
   private int itemsDropped;
   private GuiScreenHorseInventory l_Chest;
   private final WurstplusTimer timer = new WurstplusTimer();
   private boolean noBypass = false;
   @EventHandler
   private final Listener<EntityJoinWorldEvent> OnWorldEvent = new Listener((p_Event) -> {
      if (p_Event.getEntity() == mc.field_71439_g) {
         this.set_disable();
      }

   }, new Predicate[0]);

   public WurstplusAutoDupe() {
      super(WurstplusCategory.WURSTPLUS_EXPLOIT);
      this.name = "Auto Dupe";
      this.tag = "AutoDupe";
      this.description = "dupes";
   }

   protected void enable() {
      this.timer.reset();
      this.start = true;
   }

   protected void disable() {
      this.noBypass = false;
      this.doDrop = false;
      this.doChest = false;
      this.doSneak = false;
      this.start = false;
      this.finished = false;
      this.grounded = false;
      this.itemsToDupe = 0;
      this.itemsMoved = 0;
      this.itemsDropped = 0;
      this.timer.reset();
   }

   public void update() {
      if (Keyboard.isKeyDown(1)) {
         this.set_disable();
      } else if (this.finished) {
         this.finished = false;
         this.itemsMoved = 0;
         this.itemsDropped = 0;
         this.start = true;
      } else if (this.timer.passed((long)this.delay.get_value(1) * 100L)) {
         this.timer.reset();
         if (this.doSneak) {
            if (!mc.field_71439_g.func_70093_af()) {
               mc.field_71474_y.field_74311_E.field_74513_e = true;
            } else {
               mc.field_71474_y.field_74311_E.field_74513_e = false;
               this.doSneak = false;
               if (!this.hit_ground.get_value(true)) {
                  this.finished = true;
               } else {
                  this.grounded = true;
               }

            }
         } else if (this.grounded && mc.field_71439_g.field_70122_E) {
            this.grounded = false;
            this.finished = true;
         } else {
            if (this.start) {
               this.itemsToDupe = 0;
               this.itemsMoved = 0;
               Entity l_Entity = (Entity)mc.field_71441_e.field_72996_f.stream().filter(this::isValidEntity).min(Comparator.comparing((p_Entity) -> {
                  return mc.field_71439_g.func_70032_d(p_Entity);
               })).orElse((Object)null);
               if (l_Entity instanceof AbstractChestHorse) {
                  AbstractChestHorse l_entity = (AbstractChestHorse)l_Entity;
                  if (!l_entity.func_190695_dh()) {
                     int l_Slot = this.getChestInHotbar();
                     if (l_Slot != -1 && mc.field_71439_g.field_71071_by.field_70461_c != l_Slot) {
                        mc.field_71439_g.field_71071_by.field_70461_c = l_Slot;
                        mc.field_71442_b.func_78765_e();
                        mc.field_71442_b.func_187097_a(mc.field_71439_g, l_entity, EnumHand.MAIN_HAND);
                     } else {
                        if (mc.field_71439_g.field_71071_by.field_70461_c != l_Slot) {
                           WurstplusMessageUtil.send_client_message("No chests in hotbar");
                           this.set_disable();
                           return;
                        }

                        mc.field_71442_b.func_187097_a(mc.field_71439_g, l_entity, EnumHand.MAIN_HAND);
                     }
                  }

                  this.start = false;
                  mc.field_71442_b.func_187097_a(mc.field_71439_g, l_entity, EnumHand.MAIN_HAND);
                  mc.field_71439_g.func_175163_u();
                  this.doChest = true;
               }
            }

            if (this.doChest && !(mc.field_71462_r instanceof GuiScreenHorseInventory)) {
               this.doChest = false;
               this.start = true;
            } else {
               if (mc.field_71462_r instanceof GuiScreenHorseInventory) {
                  this.l_Chest = (GuiScreenHorseInventory)mc.field_71462_r;
                  this.itemsToDupe = this.getItemsToDupe();

                  for(int l_I = 2; l_I < this.l_Chest.field_147029_w.func_70302_i_() + 1; ++l_I) {
                     ItemStack l_Stack = this.l_Chest.field_147029_w.func_70301_a(l_I);
                     if ((this.itemsToDupe == 0 || this.itemsMoved == this.l_Chest.field_147029_w.func_70302_i_() - 2) && this.doChest || this.itemsDropped >= this.itemsMoved && this.doDrop) {
                        break;
                     }

                     if ((l_Stack.func_190926_b() || l_Stack.func_77973_b() == Items.field_190931_a) && this.doChest) {
                        this.HandleStoring(this.l_Chest.field_147002_h.field_75152_c, this.l_Chest.field_147029_w.func_70302_i_() - 9);
                        --this.itemsToDupe;
                        this.itemsMoved = this.getItemsInRidingEntity();
                        return;
                     }

                     if (!this.doChest && (!this.shulker_only.get_value(true) || l_Stack.func_77973_b() instanceof ItemShulkerBox) && !l_Stack.func_190926_b() && this.doDrop) {
                        if (this.canStore()) {
                           mc.field_71442_b.func_187098_a(mc.field_71439_g.field_71070_bA.field_75152_c, l_I, 0, ClickType.QUICK_MOVE, mc.field_71439_g);
                        } else {
                           mc.field_71442_b.func_187098_a(this.l_Chest.field_147002_h.field_75152_c, l_I, -999, ClickType.THROW, mc.field_71439_g);
                        }

                        ++this.itemsDropped;
                        return;
                     }
                  }

                  if (this.doChest) {
                     this.doChest = false;
                     this.doDupe();
                     return;
                  }

                  if (this.doDrop) {
                     this.doDrop = false;
                     mc.field_71439_g.func_71053_j();
                     mc.field_71474_y.field_74311_E.field_74513_e = true;
                     this.doSneak = true;
                  }
               }

            }
         }
      }
   }

   private boolean isValidEntity(Entity entity) {
      if (!(entity instanceof AbstractChestHorse)) {
         return false;
      } else {
         AbstractChestHorse l_ChestHorse = (AbstractChestHorse)entity;
         return !l_ChestHorse.func_70631_g_() && l_ChestHorse.func_110248_bS();
      }
   }

   private int getChestInHotbar() {
      for(int i = 0; i < 9; ++i) {
         ItemStack stack = mc.field_71439_g.field_71071_by.func_70301_a(i);
         if (stack != ItemStack.field_190927_a && stack.func_77973_b() instanceof ItemBlock) {
            Block block = ((ItemBlock)stack.func_77973_b()).func_179223_d();
            if (block instanceof BlockChest) {
               return i;
            }
         }
      }

      return -1;
   }

   private void HandleStoring(int p_WindowId, int p_Slot) {
      for(int l_Y = 9; l_Y < mc.field_71439_g.field_71069_bz.field_75151_b.size() - 1; ++l_Y) {
         ItemStack l_InvStack = mc.field_71439_g.field_71069_bz.func_75139_a(l_Y).func_75211_c();
         if (!l_InvStack.func_190926_b() && l_InvStack.func_77973_b() != Items.field_190931_a && (l_InvStack.func_77973_b() instanceof ItemShulkerBox || !this.shulker_only.get_value(true))) {
            mc.field_71442_b.func_187098_a(p_WindowId, l_Y + p_Slot, 0, ClickType.QUICK_MOVE, mc.field_71439_g);
            return;
         }
      }

   }

   private void doDupe() {
      this.noBypass = true;
      Entity l_Entity = (Entity)mc.field_71441_e.field_72996_f.stream().filter(this::isValidEntity).min(Comparator.comparing((p_Entity) -> {
         return mc.field_71439_g.func_70032_d(p_Entity);
      })).orElse((Object)null);
      if (l_Entity instanceof AbstractChestHorse) {
         mc.field_71439_g.field_71174_a.func_147297_a(new CPacketUseEntity(l_Entity, EnumHand.MAIN_HAND, l_Entity.func_174791_d()));
         this.noBypass = false;
         this.doDrop = true;
      }

   }

   private int getItemsToDupe() {
      int i = 0;

      for(int l_Y = 9; l_Y < mc.field_71439_g.field_71069_bz.field_75151_b.size() - 1; ++l_Y) {
         ItemStack l_InvStack = mc.field_71439_g.field_71069_bz.func_75139_a(l_Y).func_75211_c();
         if (!l_InvStack.func_190926_b() && l_InvStack.func_77973_b() != Items.field_190931_a && (l_InvStack.func_77973_b() instanceof ItemShulkerBox || !this.shulker_only.get_value(true))) {
            ++i;
         }
      }

      if (i > this.l_Chest.field_147029_w.func_70302_i_() - 1) {
         i = this.l_Chest.field_147029_w.func_70302_i_() - 1;
      }

      return i;
   }

   private int getItemsInRidingEntity() {
      int i = 0;

      for(int l_I = 2; l_I < this.l_Chest.field_147029_w.func_70302_i_() + 1; ++l_I) {
         ItemStack l_ItemStack = this.l_Chest.field_147029_w.func_70301_a(l_I);
         if (!l_ItemStack.func_190926_b() && l_ItemStack.func_77973_b() != Items.field_190931_a) {
            ++i;
         }
      }

      return i;
   }

   private boolean canStore() {
      for(int l_Y = 9; l_Y < mc.field_71439_g.field_71069_bz.field_75151_b.size() - 1; ++l_Y) {
         ItemStack l_InvStack = mc.field_71439_g.field_71069_bz.func_75139_a(l_Y).func_75211_c();
         if (l_InvStack.func_190926_b() || l_InvStack.func_77973_b() == Items.field_190931_a) {
            return true;
         }
      }

      return false;
   }

   public boolean ignoreMountBypass() {
      return this.noBypass;
   }
}
